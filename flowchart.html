<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      themeVariables: {
        fontFamily: 'Arial',
        fontSize: '13px',
        primaryColor: '#f9f',
        primaryTextColor: '#000000',
        primaryBorderColor: '#333',
        lineColor: '#333',
        secondaryColor: '#eef',
        secondaryTextColor: '#000000',
        tertiaryColor: '#dfd',
        tertiaryTextColor: '#000000',
        quaternaryColor: '#ffe',
        quaternaryTextColor: '#000000'
      }
    });
  </script>
  <style>
    body {
      background-color: white;
      font-family: Arial, sans-serif;
      margin: 20px;
    }
  </style>
</head>
<body>
  <div class="mermaid">
flowchart TD
    subgraph Azure [Azure DevOps]
        ADP[Azure Pipeline]
        ADT[Test Cases]
        ADA[Self-hosted Agent]
    end

    subgraph GitHub [GitHub Cloud]
        GHR[sbsaa Repository]
        GHA[GitHub Actions]
        GHP[GitHub Pages]
    end

    subgraph Storage [Git Storage]
        GSR[git_storage repo]
        APT[appium-tests/]
        SBT[sbsaa-tests/]
        VER[version tracking]
    end

    subgraph Runner [Self-Hosted Runner WIN10]
        SH[Actions Runner]
        AS[Appium Server]
        PY[Python + pytest]
        UH[History Manager]
        AO[Allure Generator]
        ADB[ADB Bridge]
    end

    subgraph Device [Android Device]
        AOS[Android OS]
        SA[Weather App]
        ADBD[ADB Daemon]
    end

    ADP -->|"Push [test] commit"| GHR
    GHR -->|"Trigger"| GHA
    GHA -->|"Run on"| SH
    SH -->|"Load History"| GSR
    SH -->|"Clone Code"| GHR
    SH -->|"Execute Tests"| AS
    AS -->|"Control via"| ADB
    ADB -->|"Connect to"| ADBD
    ADBD -->|"Test App"| SA
    PY -->|"Update Results"| ADT
    PY -->|"Process Data"| UH
    UH -->|"Generate Report"| AO
    AO -->|"Deploy to"| GHP
    AO -->|"Save History"| GSR
    ADA -->|"Hosts"| ADP

    style Azure fill:#e6f3ff
    style GitHub fill:#f9f
    style Storage fill:#ffe
    style Runner fill:#eef
    style Device fill:#dfd
  </div>

  <h3>Hybrid CI/CD Architecture Features:</h3>
  <ul>
    <li><strong>Dual Trigger System:</strong> Manual execution via Azure DevOps or automatic via GitHub commits with [test]</li>
    <li><strong>Azure Integration:</strong> Test Cases automatically updated with execution results and status transitions</li>
    <li><strong>Git Storage Database:</strong> Centralized history persistence across multiple projects</li>
    <li><strong>Project Isolation:</strong> Separate namespaces (appium-tests, sbsaa-tests) prevent data contamination</li>
    <li><strong>Version Tracking:</strong> App version information stored and tracked across test runs</li>
    <li><strong>Cross-Platform Agents:</strong> Azure self-hosted agent triggers GitHub Actions runner</li>
    <li><strong>Real Device Testing:</strong> Hardware-accelerated execution with ADB shell support</li>
    <li><strong>Comprehensive Reporting:</strong> Allure reports with Azure DevOps traceability</li>
  </ul>

  <h3>Execution Flow Options:</h3>
  
  <h4>Option 1: Azure DevOps Trigger</h4>
  <ol>
    <li>Manually run Azure DevOps pipeline</li>
    <li>Pipeline pushes empty commit with [test] to GitHub repository</li>
    <li>GitHub Actions detects [test] keyword and triggers workflow</li>
    <li>Continue with standard test execution flow</li>
  </ol>

  <h4>Option 2: GitHub Direct Trigger</h4>
  <ol>
    <li>Push code with [test] in commit message to GitHub</li>
    <li>GitHub Actions immediately triggers workflow</li>
    <li>Continue with standard test execution flow</li>
  </ol>

  <h4>Standard Test Execution Flow:</h4>
  <ol>
    <li>Load previous test history from git storage</li>
    <li>Prepare history files for current test run</li>
    <li>Execute pytest test suite against real Android device</li>
    <li>Update Azure DevOps Test Cases with pass/fail results</li>
    <li>Generate Allure HTML report with historical trends</li>
    <li>Clean up malformed data that Allure injects</li>
    <li>Save updated history and version info to git storage</li>
    <li>Deploy final report to GitHub Pages</li>
  </ol>

  <h3>Azure DevOps Integration:</h3>
  <ul>
    <li><strong>Test Case Management:</strong> Work items automatically updated with test results</li>
    <li><strong>Traceability:</strong> Direct links between test functions and Azure work items</li>
    <li><strong>Status Transitions:</strong> Test Cases move from Design â†’ Closed on pass, stay Ready on fail</li>
    <li><strong>Execution History:</strong> Detailed logs stored in Azure DevOps work item history</li>
    <li><strong>Manual Triggering:</strong> On-demand test execution from Azure DevOps UI</li>
  </ul>
</body>
</html>